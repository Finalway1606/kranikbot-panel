{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 sidebar p-3">
            <h5 class="mb-3">🎮 Menu</h5>
            <ul class="nav nav-pills flex-column" id="nav-tab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="dashboard-tab" data-bs-toggle="pill" href="#dashboard-content" role="tab">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="control-tab" data-bs-toggle="pill" href="#control-content" role="tab">
                        <i class="bi bi-controller"></i> Kontrola Botów
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="stats-tab" data-bs-toggle="pill" href="#stats-content" role="tab">
                        <i class="bi bi-graph-up"></i> Statystyki
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="leaderboard-tab" data-bs-toggle="pill" href="#leaderboard-content" role="tab">
                        <i class="bi bi-trophy"></i> Ranking
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="points-tab" data-bs-toggle="pill" href="#points-content" role="tab">
                        <i class="bi bi-gem"></i> Punkty
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="logs-tab" data-bs-toggle="pill" href="#logs-content" role="tab">
                        <i class="bi bi-journal-text"></i> Logi
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10 p-4">
            <div class="tab-content" id="nav-tabContent">
                
                <!-- Dashboard Tab -->
                <div class="tab-pane fade show active" id="dashboard-content" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="bi bi-speedometer2"></i> Dashboard</h2>
                        <div class="d-flex gap-3">
                            <span id="twitch-status" class="status-indicator status-offline"></span>
                            <span>Twitch: Offline</span>
                            <span id="discord-status" class="status-indicator status-offline"></span>
                            <span>Discord: Offline</span>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-title">👥 Użytkownicy</div>
                                <div class="stat-value" id="quick-users">0</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card green">
                                <div class="stat-title">💎 Punkty</div>
                                <div class="stat-value" id="quick-points">0</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card orange">
                                <div class="stat-title">💬 Wiadomości</div>
                                <div class="stat-value" id="quick-messages">0</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card red">
                                <div class="stat-title">📈 Średnia</div>
                                <div class="stat-value" id="quick-avg">0.0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">🚀 Szybkie Akcje</div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-success" onclick="startAllBots()">
                                            <i class="bi bi-play-fill"></i> Uruchom wszystkie boty
                                        </button>
                                        <button class="btn btn-danger" onclick="stopAllBots()">
                                            <i class="bi bi-stop-fill"></i> Zatrzymaj wszystkie boty
                                        </button>
                                        <button class="btn btn-warning" onclick="restartAllBots()">
                                            <i class="bi bi-arrow-clockwise"></i> Restart wszystkich botów
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">📊 Top Użytkownicy</div>
                                <div class="card-body">
                                    <div id="top-users-list">
                                        <div class="text-center text-muted">
                                            <div class="loading"></div>
                                            <p>Ładowanie...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Control Tab -->
                <div class="tab-pane fade" id="control-content" role="tabpanel">
                    <h2><i class="bi bi-controller"></i> Kontrola Botów</h2>
                    
                    <div class="row">
                        <!-- Twitch Bot -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">📺 Twitch Bot</div>
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <span id="twitch-status-control" class="status-indicator status-offline"></span>
                                        <span id="twitch-status-text">Status: Offline</span>
                                    </div>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-success" onclick="controlBot('twitch', 'start')" id="twitch-start">
                                            <i class="bi bi-play-fill"></i> Start
                                        </button>
                                        <button class="btn btn-danger" onclick="controlBot('twitch', 'stop')" id="twitch-stop">
                                            <i class="bi bi-stop-fill"></i> Stop
                                        </button>
                                        <button class="btn btn-warning" onclick="controlBot('twitch', 'restart')" id="twitch-restart">
                                            <i class="bi bi-arrow-clockwise"></i> Restart
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Discord Bot -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">💬 Discord Bot</div>
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <span id="discord-status-control" class="status-indicator status-offline"></span>
                                        <span id="discord-status-text">Status: Offline</span>
                                    </div>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-success" onclick="controlBot('discord', 'start')" id="discord-start">
                                            <i class="bi bi-play-fill"></i> Start
                                        </button>
                                        <button class="btn btn-danger" onclick="controlBot('discord', 'stop')" id="discord-stop">
                                            <i class="bi bi-stop-fill"></i> Stop
                                        </button>
                                        <button class="btn btn-warning" onclick="controlBot('discord', 'restart')" id="discord-restart">
                                            <i class="bi bi-arrow-clockwise"></i> Restart
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Tab -->
                <div class="tab-pane fade" id="stats-content" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="bi bi-graph-up"></i> Statystyki</h2>
                        <button class="btn btn-primary" onclick="refreshStats()">
                            <i class="bi bi-arrow-clockwise"></i> Odśwież
                        </button>
                    </div>

                    <!-- Detailed Stats -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-title">👥 Użytkownicy</div>
                                <div class="stat-value" id="total-users">0</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card green">
                                <div class="stat-title">💎 Punkty</div>
                                <div class="stat-value" id="total-points">0</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card orange">
                                <div class="stat-title">💬 Wiadomości</div>
                                <div class="stat-value" id="total-messages">0</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card red">
                                <div class="stat-title">📈 Średnia</div>
                                <div class="stat-value" id="avg-points">0.0</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">📊 Szczegółowe Statystyki</div>
                        <div class="card-body">
                            <div id="detailed-stats">
                                <div class="text-center">
                                    <div class="loading"></div>
                                    <p>Ładowanie statystyk...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Leaderboard Tab -->
                <div class="tab-pane fade" id="leaderboard-content" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="bi bi-trophy"></i> Ranking</h2>
                        <button class="btn btn-primary" onclick="refreshLeaderboard()">
                            <i class="bi bi-arrow-clockwise"></i> Odśwież
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-header">🏆 Top Użytkownicy</div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-dark table-striped">
                                    <thead>
                                        <tr>
                                            <th>🏆 Pozycja</th>
                                            <th>👤 Użytkownik</th>
                                            <th>💎 Punkty</th>
                                            <th>💬 Wiadomości</th>
                                            <th>📅 Ostatnio</th>
                                            <th>👥 Follower</th>
                                        </tr>
                                    </thead>
                                    <tbody id="leaderboard-table">
                                        <tr>
                                            <td colspan="6" class="text-center">
                                                <div class="loading"></div>
                                                Ładowanie rankingu...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Points Tab -->
                <div class="tab-pane fade" id="points-content" role="tabpanel">
                    <h2><i class="bi bi-gem"></i> Zarządzanie Punktami</h2>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">➕ Dodaj Punkty</div>
                                <div class="card-body">
                                    <form id="add-points-form">
                                        <div class="mb-3">
                                            <label for="username" class="form-label">Nazwa użytkownika</label>
                                            <input type="text" class="form-control" id="username" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="points" class="form-label">Liczba punktów</label>
                                            <input type="number" class="form-control" id="points" required>
                                        </div>
                                        <button type="submit" class="btn btn-success">
                                            <i class="bi bi-plus-circle"></i> Dodaj Punkty
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">🗑️ Wyczyść Punkty</div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-warning" onclick="clearPoints('all')">
                                            <i class="bi bi-trash"></i> Wyczyść wszystkie punkty
                                        </button>
                                        <button class="btn btn-danger" onclick="clearPoints('non_followers')">
                                            <i class="bi bi-person-x"></i> Wyczyść punkty nie-followerów
                                        </button>
                                    </div>
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            <i class="bi bi-exclamation-triangle"></i>
                                            Te operacje są nieodwracalne!
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Logs Tab -->
                <div class="tab-pane fade" id="logs-content" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="bi bi-journal-text"></i> Logi Systemu</h2>
                        <button class="btn btn-secondary" onclick="clearLogs()">
                            <i class="bi bi-trash"></i> Wyczyść
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-header">📝 Logi na żywo</div>
                        <div class="card-body">
                            <div id="log-container" class="log-container">
                                <div class="text-muted">Oczekiwanie na logi...</div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Bot control functions
    async function controlBot(botType, action) {
        const buttonId = `${botType}-${action}`;
        const originalText = document.getElementById(buttonId).innerHTML;
        
        showLoading(buttonId);
        
        try {
            const response = await fetch(`/api/bot/${botType}/${action}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert(result.message, 'success');
                updateStatus();
            } else {
                showAlert(result.error, 'danger');
            }
        } catch (error) {
            showAlert('Błąd komunikacji z serwerem', 'danger');
        } finally {
            hideLoading(buttonId, originalText);
        }
    }

    async function startAllBots() {
        await controlBot('twitch', 'start');
        await controlBot('discord', 'start');
    }

    async function stopAllBots() {
        await controlBot('twitch', 'stop');
        await controlBot('discord', 'stop');
    }

    async function restartAllBots() {
        await controlBot('twitch', 'restart');
        await controlBot('discord', 'restart');
    }

    // Stats functions
    async function updateStats() {
        try {
            const response = await fetch('/api/stats');
            const data = await response.json();
            
            if (data.error) {
                console.error('Błąd ładowania statystyk:', data.error);
                return;
            }
            
            // Update quick stats
            document.getElementById('quick-users').textContent = data.total_users;
            document.getElementById('quick-points').textContent = data.total_points;
            document.getElementById('quick-messages').textContent = data.total_messages;
            document.getElementById('quick-avg').textContent = data.avg_points;
            
            // Update detailed stats
            document.getElementById('total-users').textContent = data.total_users;
            document.getElementById('total-points').textContent = data.total_points;
            document.getElementById('total-messages').textContent = data.total_messages;
            document.getElementById('avg-points').textContent = data.avg_points;
            
            // Update top users
            updateTopUsers(data.top_users);
            
        } catch (error) {
            console.error('Błąd aktualizacji statystyk:', error);
        }
    }

    function updateTopUsers(topUsers) {
        const container = document.getElementById('top-users-list');
        if (!topUsers || topUsers.length === 0) {
            container.innerHTML = '<p class="text-muted">Brak danych</p>';
            return;
        }
        
        const html = topUsers.slice(0, 5).map((user, index) => `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span>${index + 1}. ${user.username}</span>
                <span class="badge bg-primary">${user.points} pkt</span>
            </div>
        `).join('');
        
        container.innerHTML = html;
    }

    async function refreshStats() {
        await updateStats();
        showAlert('Statystyki odświeżone', 'success');
    }

    // Leaderboard functions
    async function refreshLeaderboard() {
        try {
            const response = await fetch('/api/leaderboard');
            const data = await response.json();
            
            if (data.error) {
                showAlert(data.error, 'danger');
                return;
            }
            
            const tbody = document.getElementById('leaderboard-table');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Brak danych</td></tr>';
                return;
            }
            
            const html = data.map(user => `
                <tr>
                    <td>${user.rank}</td>
                    <td>${user.username}</td>
                    <td>${user.points}</td>
                    <td>${user.messages}</td>
                    <td>${user.last_seen || 'Nigdy'}</td>
                    <td>${user.is_follower ? '✅' : '❌'}</td>
                </tr>
            `).join('');
            
            tbody.innerHTML = html;
            
        } catch (error) {
            showAlert('Błąd ładowania rankingu', 'danger');
        }
    }

    // Points management
    document.getElementById('add-points-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const username = document.getElementById('username').value;
        const points = document.getElementById('points').value;
        
        try {
            const response = await fetch('/api/points/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, points: parseInt(points) })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert(result.message, 'success');
                document.getElementById('add-points-form').reset();
                updateStats();
            } else {
                showAlert(result.error, 'danger');
            }
        } catch (error) {
            showAlert('Błąd dodawania punktów', 'danger');
        }
    });

    async function clearPoints(type) {
        const confirmMessage = type === 'all' 
            ? 'Czy na pewno chcesz wyczyścić punkty WSZYSTKICH użytkowników?' 
            : 'Czy na pewno chcesz wyczyścić punkty nie-followerów?';
        
        if (!confirm(confirmMessage)) {
            return;
        }
        
        try {
            const response = await fetch('/api/points/clear', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ type })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert(`Wyczyszczono punkty ${result.affected} użytkowników`, 'success');
                updateStats();
                refreshLeaderboard();
            } else {
                showAlert(result.error, 'danger');
            }
        } catch (error) {
            showAlert('Błąd czyszczenia punktów', 'danger');
        }
    }

    function clearLogs() {
        const logContainer = document.getElementById('log-container');
        logContainer.innerHTML = '<div class="text-muted">Logi wyczyszczone</div>';
    }

    // Update status indicators in control tab
    function updateStatusIndicators(status) {
        // Dashboard indicators
        const twitchIndicator = document.getElementById('twitch-status');
        const discordIndicator = document.getElementById('discord-status');
        
        if (twitchIndicator) {
            twitchIndicator.className = `status-indicator ${status.twitch ? 'status-online' : 'status-offline'}`;
            twitchIndicator.nextElementSibling.textContent = `Twitch: ${status.twitch ? 'Online' : 'Offline'}`;
        }
        
        if (discordIndicator) {
            discordIndicator.className = `status-indicator ${status.discord ? 'status-online' : 'status-offline'}`;
            discordIndicator.nextElementSibling.textContent = `Discord: ${status.discord ? 'Online' : 'Offline'}`;
        }
        
        // Control tab indicators
        const twitchControlIndicator = document.getElementById('twitch-status-control');
        const discordControlIndicator = document.getElementById('discord-status-control');
        const twitchStatusText = document.getElementById('twitch-status-text');
        const discordStatusText = document.getElementById('discord-status-text');
        
        if (twitchControlIndicator) {
            twitchControlIndicator.className = `status-indicator ${status.twitch ? 'status-online' : 'status-offline'}`;
            twitchStatusText.textContent = `Status: ${status.twitch ? 'Online' : 'Offline'}`;
        }
        
        if (discordControlIndicator) {
            discordControlIndicator.className = `status-indicator ${status.discord ? 'status-online' : 'status-offline'}`;
            discordStatusText.textContent = `Status: ${status.discord ? 'Online' : 'Offline'}`;
        }
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        updateStats();
        refreshLeaderboard();
        
        // Add tab change listeners
        document.querySelectorAll('[data-bs-toggle="pill"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function(e) {
                const target = e.target.getAttribute('href');
                if (target === '#stats-content') {
                    updateStats();
                } else if (target === '#leaderboard-content') {
                    refreshLeaderboard();
                }
            });
        });
    });
</script>
{% endblock %}